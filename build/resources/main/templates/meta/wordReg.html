<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/layout.css">
    <script src="/js/sidebar.js" defer></script>
    <script src="/js/layout.js" defer></script>
    <script src="/js/commonUtils.js"></script>
</head>
<body>

<div id="topbarContainer"></div>
<div class="container">
    <div id="sidebarContainer"></div>
    <div class="mainContainer" id="mainContainer">
        <div class="form-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <h2 style="margin:0;"> ‚úÖ ÌëúÏ§ÄÎã®Ïñ¥ Ïã†Ï≤≠</h2>
            <div class="button-group" style="display:flex; gap:8px;">
                <button id="btnPopup" class="btn-row">Îã®Ïñ¥Í≤ÄÏ¶ù</button>
                <button id="btnInit" class="btn">Ï¥àÍ∏∞Ìôî</button>
                <button id="btnSave"  class="btn">Ï†ÄÏû•</button>
            </div>
        </div>
        <div class="divider-h"></div>
            <form id="mainForm">
                <table class="form-table">
                <tr>
                    <th>Îã®Ïñ¥Î™Ö <span style="color:red">*</span></th>
                    <td colspan="2"><input type="text" id="wordNm" name="wordNm" class="form-input" required> </td>
                </tr>
                </table>
                <div class="divider-h"></div>
                <table class="form-table">
                <tr>
                    <th>ÏòÅÎ¨∏ÏïΩÏñ¥Î™Ö <span style="color:red">*</span></th>
                    <td colspan="2"> <input type="text" id="engAbbrNm" name="engAbbrNm" class="form-input"  required> </td>
                </tr>
                <tr>
                    <th>ÏòÅÎ¨∏Î™Ö</th>
                    <td colspan="2"><input type="text" id="engNm" name="engNm" class="form-input"  > </td>
                </tr>
                <tr>
                    <th>ÏÑ§Î™Ö</th>
                    <td colspan="2"> <textarea id="expln" name="expln" class="form-input" rows="10" ></textarea> </td>
                </tr>
                <tr>
                    <th>ÏÉÅÌÉú</th>
                    <td colspan="2">
                        <select id="stat"  name="stat" class="form-input">
                            <option value="0">Ïã†Ï≤≠</option>
                            <option value="1">ÏÇ¨Ïö©</option>
                            <option value="9">ÎØ∏ÏÇ¨Ïö©</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>ID</th>
                    <td colspan="2"> <input type="text" id="id" name="id" class="form-input" readonly> </td>
                </tr>
                </table>
                <table class="form-table">
                <tr>
                    <th>ÏµúÏ¥àÎì±Î°ù</th>
                    <td style="display:flex; gap:5px;">
                        <input type="text" id="crtId" name="crtId" class="form-input"  readonly>
                        <input type="text" id="crtDttm" name="crtDttm" class="form-input"  readonly>   </td>
                </tr>
                <tr>
                    <th>ÏµúÏ¢ÖÎ≥ÄÍ≤Ω</th>
                    <td style="display:flex; gap:5px;">
                        <input type="text" id="updId" name="updId" class="form-input" readonly>
                        <input type="text" id="updDttm" name="updDttm" class="form-input"  readonly> </td>
                </tr>
            </table>
        </form>
        <div class="divider-h"></div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const mainForm = document.getElementById("mainForm");
        const btnSave = document.getElementById("btnSave");
        btnSave.disabled = true;

        const userId = localStorage.getItem('userId');
        document.getElementById("crtId").value = userId;
        document.getElementById("updId").value = userId;

        // ÌòÑÏû¨ ÌôîÎ©¥ ÏÉÅÌÉú: I(Ïã†Í∑ú), S(ÏÉÅÏÑ∏)
        let mode = "I";
        let originalData = {};

         // üî∏ ÌòÑÏû¨ Í∞íÏù¥ ÏàòÏ†ïÎêòÏóàÎäîÏßÄ Ï≤¥ÌÅ¨
          const checkChanged = () => {
            const current = formToJson(mainForm);
            const changed = Object.keys(current).some(
                key => current[key] !== originalData[key]
            );
            btnSave.disabled = !changed;
        };

        // üî∏ ÏûÖÎ†•Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ (ÏûÖÎ†•/ÏÑ†ÌÉù Î™®Îëê Î∞òÏùë)
        mainForm.querySelectorAll("input, textarea, select").forEach(el => {
            el.addEventListener("input", checkChanged);
            el.addEventListener("change", checkChanged);
        });

        // Ï†ÄÏû• Î≤ÑÌäº
        btnSave.addEventListener("click", async () => {
            let data = formToJson(mainForm);
            data = addUserAuditFields(data);

            if (!data.wordNm.trim()) {
                alert("Îã®Ïñ¥Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                mainForm.wordNm.focus();
                return;
            }
            if (!data.engAbbrNm.trim()) {
                alert("ÏòÅÎ¨∏ÏïΩÏñ¥Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                mainForm.engAbbrNm.focus();
                return;
            }
            if (!data.engNm.trim()) {
                alert("ÏòÅÎ¨∏Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                mainForm.engNm.focus();
                return;
            }

            try {
                let url = "/meta/insertWordData";
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                } else {
                    alert("Ïò§Î•ò: " + result.message);
                }

            } catch (err) {
                console.error(err);
                alert("ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            }
        });

        /** Ï¥àÍ∏∞Ìôî **/
        document.getElementById('btnInit').addEventListener('click', () => {
            document.getElementById('mainForm').reset();
        });

       document.getElementById('btnPopup').addEventListener('click', async () => {
            const inData = formToJson(mainForm);

            if (!inData.wordNm.trim()) {
                alert("Îã®Ïñ¥Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                mainForm.wordNm.focus();
                return;
            }
            try {
                const res = await fetch('/meta/getWordData', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inData)
                });

                if (!res.ok) {
                    throw new Error("ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò");
                    return;
                }
                const outData = await res.json();
                fillForm(mainForm, outData);

            } catch (err) {
                alert("Îì±Î°ù Í∞ÄÎä•Ìï©ÎãàÎã§.");
            }
        });


        // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
        document.getElementById('mainForm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Ìèº Ï†úÏ∂ú Î∞©ÏßÄ
                document.getElementById('btnPopup').click();
            }
        });

    });
</script>
</body>
</html>