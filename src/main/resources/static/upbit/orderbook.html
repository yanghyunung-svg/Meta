<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>호가 조회</title>
    <link rel="stylesheet" href="/css/upbitLayout.css">
    <script src="/js/mainLayout.js" defer></script>
    <script src="/js/sideLayout.js" defer></script>

</head>
<body>
<div class="container">
    <div id="topbarContainer"></div>
    <div id="sidebarContainer"></div>
    <div class="mainHeadContainer">
        <h2 style="margin:0;">  <span id="headerName"></span> 호가 조회</h2>
    </div>

    <div class="mainBodyContainer">
        <table id="upbit-table">
            <thead>
            <tr>
                <th>매도 잔량</th>
                <th>호가</th>
                <th>매수 잔량 </th>
                <th width="50%"></th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        async function loadOrderbook() {

            // 1. 마켓명 매핑 가져오기
            const marketRes = await fetch("https://api.upbit.com/v1/market/all");
            const marketData = await marketRes.json();
            const marketMap = {};
            marketData.forEach(m => {
              marketMap[m.market] = { korean: m.korean_name, english: m.english_name };
            });

            //const markets = ["KRW-MLK", "KRW-MOCA", "KRW-ONG"];
            const markets = ["KRW-MLK"];
            const response = await fetch(`https://api.upbit.com/v1/orderbook?markets=${markets.join(",")}`);
            const data = await response.json();
            const tbody = document.querySelector("#upbit-table tbody");
            tbody.innerHTML = "";

  data.forEach(orderbook => {
   const headerName = document.getElementById('headerName');
    headerName.innerText = ` ${orderbook.market.replace("KRW-", "")} - ${marketMap[orderbook.market]?.korean} (${marketMap[orderbook.market]?.english})`;

    // 호가 데이터
    orderbook.orderbook_units.forEach(unit => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align:right;">${unit.ask_size.toLocaleString()}</td>
        <td style="text-align:right;">${unit.ask_price.toLocaleString()}</td>
        <td style="text-align:right;"> </td>
      `;
      tbody.appendChild(row);
    });

    // 호가 데이터
    orderbook.orderbook_units.forEach(unit => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align:right;"> </td>
        <td style="text-align:right;">${unit.bid_price.toLocaleString()}</td>
        <td style="text-align:right;">${unit.bid_size.toLocaleString()}</td>
      `;
      tbody.appendChild(row);
    });

          const numericColumns = [1];
          sortTable(1, numericColumns.includes(1));


  });
}


        // 최초 실행
        loadOrderbook();


    function sortTable(columnIndex, numeric = false) {
      const table = document.getElementById("upbit-table");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      // 정렬 방향 토글 (오름차순 ↔ 내림차순)
      table.setAttribute("data-sort-dir",   "desc");

      rows.sort((a, b) => {
        let A = a.children[columnIndex].innerText.replace(/,/g, "");
        let B = b.children[columnIndex].innerText.replace(/,/g, "");

        if (numeric) {
          return  parseFloat(B) - parseFloat(A);
        } else {
          return  B.localeCompare(A);
        }
      });

      // 기존 내용 초기화 후 정렬된 행 추가
      tbody.innerHTML = "";
      rows.forEach(row => tbody.appendChild(row));
    }


    </script>


</body>
</html>
