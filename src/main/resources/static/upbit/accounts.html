<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upbit My Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --upbit-blue: #0046ff; --upbit-red: #d60000; --upbit-blue-down: #0051c7; }
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h3 { margin: 0; font-size: 14px; color: #666; }
        .card p { margin: 10px 0 0; font-size: 20px; font-weight: bold; }

        .api-input { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 10px 20px; background: var(--upbit-blue); color: white; border: none; border-radius: 6px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th { background: #f8f9fa; padding: 15px; font-size: 13px; color: #666; text-align: right; }
        td { padding: 15px; border-bottom: 1px solid #f1f1f1; text-align: right; font-size: 14px; }
        .text-left { text-align: left; }
        .plus { color: var(--upbit-red); }
        .minus { color: var(--upbit-blue-down); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>내 투자 내역</h2>
        <span id="updateTime" style="color:#888; font-size: 13px;"></span>
    </div>
    <div class="api-input">
        <input type="password" id="accessKey" placeholder="Access Key">
        <input type="password" id="secretKey" placeholder="Secret Key">
        <button onclick="fetchMyAssets()">조회하기</button>
    </div>

    <div class="summary-grid">
        <div class="card">
            <h3>총 보유자산</h3>
            <p id="totalAsset">0 KRW</p>
        </div>
        <div class="card">
            <h3>총 매수금액</h3>
            <p id="totalBuy">0 KRW</p>
        </div>
        <div class="card">
            <h3>총 평가손익</h3>
            <p id="totalProfit">0 KRW</p>
        </div>
    </div>

    <table id="assetTable">
        <thead>
        <tr>
            <th class="text-left">보유자산</th>
            <th>보유수량</th>
            <th>매수평단</th>
            <th>현재가</th>
            <th>평가금액</th>
            <th>수익률</th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="6" style="text-align:center; padding: 40px; color: #999;">API 키를 입력하고 조회를 눌러주세요.</td></tr>
        </tbody>
    </table>
</div>

<script>
    // JWT 토큰 생성 함수 (업비트 방식)
    function createJwt(accessKey, secretKey) {
        const header = { alg: "HS256", typ: "JWT" };
        const payload = {
            access_key: accessKey,
            nonce: crypto.randomUUID()
        };

        const base64UrlEncode = (obj) => {
            const str = JSON.stringify(obj);
            return btoa(unescape(encodeURIComponent(str)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        };

        const encodedHeader = base64UrlEncode(header);
        const encodedPayload = base64UrlEncode(payload);
        const signature = CryptoJS.HmacSHA256(encodedHeader + "." + encodedPayload, secretKey);
        const encodedSignature = CryptoJS.enc.Base64.stringify(signature)
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

        return `${encodedHeader}.${encodedPayload}.${encodedSignature}`;
    }

    async function fetchMyAssets() {
   //     const accessKey = document.getElementById('accessKey').value;
   //     const secretKey = document.getElementById('secretKey').value;

    <!--Access key 6Mhq0J7kcJGxrATxWs3zy7sDgeqGxBfnsgxOF9u2-->
    <!--Secret key OodlqpmxKl6RCxrVGBBxstY8ovpHQ2ltgxXUfpw8-->

        const accessKey = '6Mhq0J7kcJGxrATxWs3zy7sDgeqGxBfnsgxOF9u2';
        const secretKey = 'OodlqpmxKl6RCxrVGBBxstY8ovpHQ2ltgxXUfpw8';

        if(!accessKey || !secretKey) return alert("API 키를 입력하세요.");

        try {
            const token = createJwt(accessKey, secretKey);

            //const response = await fetch('https://api.upbit.com/v1/accounts', {
            const response = await fetch('https://cors-anywhere.herokuapp.com/https://api.upbit.com/v1/accounts', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'x-requested-with': 'XMLHttpRequest'
                }
            });
            const accounts = await response.json();

            // 현재가 조회를 위한 마켓 코드 추출
            const krwMarkets = accounts
                .filter(a => a.currency !== 'KRW')
                .map(a => `KRW-${a.currency}`);

            const tickerRes = await fetch(`https://cors-anywhere.herokuapp.com/https://api.upbit.com/v1/ticker?markets=${krwMarkets.join(',')}`, {
                headers: { 'x-requested-with': 'XMLHttpRequest' }
            });
            const tickers = await tickerRes.json();
            const tickerMap = Object.fromEntries(tickers.map(t => [t.market, t.trade_price]));
            renderTable(accounts, tickerMap);
        } catch (err) {
            console.error(err);
            alert("조회 실패! CORS 설정을 확인하거나 API 키를 확인하세요.");
        }
    }

    function renderTable(accounts, tickerMap) {
        const tbody = document.querySelector("#assetTable tbody");
        let totalBuy = 0, totalEval = 0, pureKrw = 0;

        tbody.innerHTML = accounts.map(acc => {
            const isKrw = acc.currency === 'KRW';
            const currentPrice = tickerMap[`KRW-${acc.currency}`] || 0;
            const buyPrice = Number(acc.avg_buy_price);
            const balance = Number(acc.balance);

            if(isKrw) {
                pureKrw = balance;
                return "";
            }

            const buyAmount = buyPrice * balance;
            const evalAmount = currentPrice * balance;
            const profitRate = buyAmount > 0 ? ((evalAmount / buyAmount - 1) * 100).toFixed(2) : 0;

            totalBuy += buyAmount;
            totalEval += evalAmount;

            return `
                <tr>
                    <td class="text-left"><b>${acc.currency}</b></td>
                    <td>${balance.toLocaleString(undefined, {maximumFractionDigits: 8})}</td>
                    <td>${buyPrice.toLocaleString()}</td>
                    <td>${currentPrice.toLocaleString()}</td>
                    <td>${Math.floor(evalAmount).toLocaleString()}</td>
                    <td class="${profitRate >= 0 ? 'plus' : 'minus'}">${profitRate}%</td>
                </tr>
            `;
        }).join('');

        document.getElementById('totalAsset').innerText = Math.floor(totalEval + pureKrw).toLocaleString() + " KRW";
        document.getElementById('totalBuy').innerText = Math.floor(totalBuy).toLocaleString() + " KRW";
        document.getElementById('totalProfit').innerText = Math.floor(totalEval - totalBuy).toLocaleString() + " KRW";
        document.getElementById('updateTime').innerText = `갱신: ${new Date().toLocaleTimeString()}`;
    }
</script>
</body>
</html>