<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/layout.css">
    <script src="/js/layout.js" defer></script>
    <script src="/js/commonUtils.js"></script>
</head>
<body>

<div id="topbarContainer"></div>
<div class="container">
    <div id="sidebarContainer"></div>
    <div class="mainContainer" id="mainContainer">
        <div class="form-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <h2 style="margin:0;"> âœ… ìƒì„¸ì½”ë“œ ì‹ ì²­</h2>
            <div class="button-group" style="display:flex; gap:8px;">
                <button id="btnCheck" class="btn-row">ì½”ë“œê²€ì¦</button>
                <button id="btnInit" class="btn">ì´ˆê¸°í™”</button>
                <button id="btnSave"  class="btn">ì €ì¥</button>
            </div>
        </div>
        <form id="mainForm">
            <table class="form-table">
            <tr>
                <th>ê³µí†µì½”ë“œ <span style="color:red">*</span></th>
                <td style="display:flex; align-items:center; gap:4px;">
                    <input type="text" id="grpCd" name="grpCd" class="form-input">
                    <button id="btnPopup">ğŸ”</button>
                </td>
            </tr>
            <tr>
                <th>ê³µí†µì½”ë“œëª… <span style="color:red">*</span></th>
                <td colspan="2"><input type="text" id="grpNm"  name="grpNm" class="form-input" readonly></td>
            </tr>

            <tr>
                <th>ìƒì„¸ì½”ë“œ <span style="color:red">*</span></th>
                <td colspan="2"> <input type="text" id="cd" name="cd" class="form-input"  required> </td>
            </tr>
            <tr>
                <th>ìƒì„¸ì½”ë“œëª… <span style="color:red">*</span></th>
                <td colspan="2"> <input type="text" id="cdNm" name="cdNm" class="form-input"  required> </td>
            </tr>
            <tr>
                <th>ì •ë ¬ìˆœì„œ</th>
                <td colspan="2"> <input type="text" id="ord" name="ord" class="form-input"  > </td>
            </tr>
            <tr>
                <th>ë¹„ê³ </th>
                <td colspan="2"> <textarea id="rmk" name="rmk" class="form-input" rows="10" ></textarea> </td>
            </tr>
            <tr>
                <th>ì‚¬ìš©ì—¬ë¶€</th>
                <td colspan="2">
                    <select id="useYn"  name="useYn" class="form-input">
                        <option value="Y">ì‚¬ìš©</option>
                        <option value="N">ë¯¸ì‚¬ìš©</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>ìµœì´ˆë“±ë¡</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="crtId" name="crtId" class="form-input"  readonly>
                    <input type="text" id="crtDttm" name="crtDttm" class="form-input"  readonly>   </td>
            </tr>
            <tr>
                <th>ìµœì¢…ë³€ê²½</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="updId" name="updId" class="form-input" readonly>
                    <input type="text" id="updDttm" name="updDttm" class="form-input"  readonly> </td>
            </tr>
        </table>
    </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const mainForm = document.getElementById("mainForm");
        const btnSave = document.getElementById("btnSave");

        let mode = "I";
        let originalData = {};

        const checkChanged = () => {
            const current = formToJson(mainForm);
            const changed = Object.keys(current).some(
                key => String(current[key]) !== String(originalData[key])
            );
            btnSave.disabled = !changed;
        };

        mainForm.querySelectorAll("input, textarea, select").forEach(el => {
            el.addEventListener("input", checkChanged);
            el.addEventListener("change", checkChanged);
        });

        btnSave.addEventListener("click", async () => {
            let data = formToJson(mainForm);
            data = addUserAuditFields(data);

            if (!data.grpCd.trim()) {
                alert("ê³µí†µì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                mainForm.grpCd.focus();
                return;
            }
            if (!data.cd.trim()) {
                alert("ìƒì„¸ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                mainForm.cd.focus();    // â† ìˆ˜ì •ë¨
                return;
            }

            try {
                let url = "/meta/insertCodeData";

                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    alert("ì˜¤ë¥˜: " + result.message);
                }

            } catch (err) {
                alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });


       document.getElementById('btnCheck').addEventListener('click', async () => {
            const inData = formToJson(mainForm);

            if (!inData.grpCd.trim()) {
                alert("ê³µí†µì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                mainForm.grpCd.focus();
                return;
            }
            if (!inData.cd.trim()) {
                alert("ìƒì„¸ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                mainForm.cd.focus();
                return;
            }
            try {
                const res = await fetch('/meta/getCodeData', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inData)
                });

                if (!res.ok) {
                    throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
                    return;
                }
                const outData = await res.json();
                fillForm(mainForm, outData);

            } catch (err) {
                alert("ë“±ë¡ê°€ëŠ¥ í•©ë‹ˆë‹¤");
            }
        });


        /** ì´ˆê¸°í™” **/
        document.getElementById('btnInit').addEventListener('click', () => {
            document.getElementById('mainForm').reset();
        });

        document.getElementById('btnPopup').addEventListener('click', () => {
            window.open("/meta/codeGroupPopup", "ìƒì„¸ì½”ë“œ ê²€ìƒ‰", "width=700,height=500,scrollbars=yes,resizable=yes");
        });
    });

    function receiveCode(grpCd, grpNm) {
        document.getElementById("grpCd").value = grpCd;
        document.getElementById("grpNm").value = grpNm;
    }
</script>

</body>
</html>

