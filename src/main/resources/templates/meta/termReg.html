<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/mainLayout.css">
    <script src="/js/commonUtils.js" defer></script>
</head>
<body>
    <div class="popupContainer" id="popupContainer">
        <div class="popup-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <h2 class="popup-title"> ✅ 표준용어 등록</h2>
            <div class="button-group">
                <button id="btnSave" type="button" class="btn">
                    <svg viewBox="0 0 24 24" width="15" height="15">
                        <path d="M5 3h14v18H5z" fill="none" stroke="currentColor"/>
                        <path d="M9 3v6h6V3" stroke="currentColor"/>
                    </svg>
                    저장
                </button>
                <button id="btnInit" type="button" class="btn">
                    <svg viewBox="0 0 24 24" width="15" height="15">
                        <path d="M4 12a8 8 0 1 0 2.3-5.7" fill="none" stroke="currentColor"/>
                        <polyline points="4,4 4,9 9,9" fill="none" stroke="currentColor"/>
                    </svg>
                    초기화
                </button>
                <button id="btnClose" type="button" class="btn">
                    <svg viewBox="0 0 24 24" width="15" height="15">
                        <line x1="4" y1="4" x2="20" y2="20" stroke="currentColor"/>
                        <line x1="20" y1="4" x2="4" y2="20" stroke="currentColor"/>
                    </svg>
                    닫기
                </button>
            </div>
        </div>
        <div class="divider-h"></div>
        <form id="mainForm">
            <table class="popup-table">
                <tr>
                    <th>용어명 <span style="color:red">*</span></th>
                    <td style="display:flex; align-items:center; gap:4px;">
                    <input type="text" id="trmNm" name="trmNm" class="form-input" required> 
                    <button id="btnCheck" type="button" class="btn">중복검증</button></td>
                </tr>
            </table>
            <table class="popup-table">
                <tr>
                    <th>영문명 <span style="color:red">*</span></th>
                    <td > <input type="text" id="engNm" name="engNm" class="form-input"  > </td>
                </tr>
                <tr>
                    <th>도메인명</th>
                    <td>
                        <select id="dmnNm" name="dmnNm" class="form-input">
                            <option value="" selected>선택</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>설명</th>
                    <td > <textarea id="trmExpln" name="trmExpln" class="form-input" rows="20" ></textarea> </td>
                </tr>
                <tr>
                    <th>상태</th>
                    <td>
                        <select id="stat" name="stat" class="form-input">
                            <option value="0" selected>등록</option>
                            <option value="1">사용</option>
                            <option value="9">미사용</option>
                        </select>
                    </td>
                </tr>
            </table>
            <table class="popup-table">
                <tr>
                    <th>최초등록</th>
                    <td style="display:flex; gap:5px;">
                        <input type="text" id="crtId" name="crtId" class="form-input"  readonly>
                        <input type="text" id="crtDttm" name="crtDttm" class="form-input"  readonly>   </td>
                </tr>
                <tr>
                    <th>최종변경</th>
                    <td style="display:flex; gap:5px;">
                        <input type="text" id="updId" name="updId" class="form-input" readonly>
                        <input type="text" id="updDttm" name="updDttm" class="form-input"  readonly> </td>
                </tr>
            </table>
        </form>
        <div class="divider-h"></div>
    </div>
<!--</div>-->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        if (!document.forms.mainForm) return;

        const dmnNm = document.forms.mainForm.dmnNm;
        if (!dmnNm || !dmnNm.value) {
            loadDomainCombo();
        }

        const mainForm = document.getElementById("mainForm");
        const btnSave = document.getElementById("btnSave");
        const btnInit = document.getElementById("btnInit");
        const btnClose = document.getElementById("btnClose");
        const btnCheck = document.getElementById("btnCheck");

        btnSave.disabled = true;
        btnCheck.disabled = true;

        document.getElementById("trmNm").addEventListener("input", () => {
            btnCheck.disabled = false;
        });

        // 저장 버튼
        btnSave.addEventListener("click", async () => {
            let data = formToJson(mainForm);
            data = addUserAuditFields(data);

            const ok = validateRequired([
                { value: data.trmNm.trim(), message: '용어명은 필수 입력 항목입니다.', element: mainForm.trmNm },
                { value: data.engNm.trim(),  message: '영문명은 필수 입력 항목입니다.', element: mainForm.engNm },
                { value: data.trmExpln.trim(),  message: '설명은 필수 입력 항목입니다.', element: mainForm.trmExpln },
                { value: data.dmnNm.trim(),  message: '도메인명은 필수 입력 항목입니다.', element: mainForm.dmnNm },
                { value: data.stat.trim(),  message: '상태코드는 필수 입력 항목입니다.', element: mainForm.stat }
            ]);

            if (!ok) return;

            if (window.KOR.test(data.engNm)) {
                alert("영문명에는 한글을 입력할 수 없습니다.");
                mainForm.engNm.focus();
                return;
            }

            try {
                const res = await fetch("/meta/insertTermData", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert("저장되었습니다.");
                    document.getElementById('mainForm').reset();
                } else {
                    alert("오류: " + result.message);
                }

            } catch (err) {
                console.error(err);
                alert("요청 중 오류가 발생했습니다.");
            }
        });

        btnCheck.addEventListener('click', async (e) => {
            e.preventDefault();
            let inData = formToJson(mainForm);

            if (!inData.trmNm.trim()) {
                alert("용어명을 입력하세요.");
                mainForm.trmNm.focus();
                return;
            }

            btnCheck.disabled = true;

            const res = await fetch('/meta/getTermSplitData', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inData)
            });

            const textData = await res.text();

            if (!textData) {
                alert("등록 가능한 용어입니다.");
                mainForm.reset();
                document.getElementById("trmNm").value = inData.trmNm
                mainForm.engNm.focus();
                btnSave.disabled = false;
                btnCheck.disabled = true;
            } else {
                const outData = JSON.parse(textData);
                fillForm(mainForm, outData);
                if (mainForm.stat.value === '0') {
                    alert("등록 가능한 용어입니다."  );
                    mainForm.engNm.focus();
                    btnSave.disabled = false;
                } else {
                    alert("등록된 용어가 있습니다.."  );
                    btnSave.disabled = true;
                }
            }
        });

        /* 초기화 */
        btnInit.addEventListener('click', () => {
            mainForm.reset();
            btnSave.disabled = true;
            btnCheck.disabled = false;
            document.getElementById("trmNm").focus();
        });

        /* 닫기 */
        btnClose.addEventListener("click", () => window.close() );

        /* Enter Key */
        document.getElementById("trmNm").addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                btnCheck.click();
            }
        });

    });


</script>
</body>
</html>