<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/mainLayout.css">
    <script src="/js/mainLayout.js"></script>
    <script src="/js/commonUtils.js" defer></script>
</head>
<body>

<div class="popupContainer" id="popupContainer">
    <div class="popup-header">
        <h2 class="popup-title"> ✅ 사용자정보 상세</h2>
        <div class="button-group">
            <button id="btnSave" type="button" class="btn">
                <svg viewBox="0 0 24 24" width="15" height="15">
                    <path d="M5 3h14v18H5z" fill="none" stroke="currentColor"/>
                    <path d="M9 3v6h6V3" stroke="currentColor"/>
                </svg>
                저장
            </button>
            <button id="btnClose" type="button" class="btn">
                <svg viewBox="0 0 24 24" width="15" height="15">
                    <line x1="4" y1="4" x2="20" y2="20" stroke="currentColor"/>
                    <line x1="20" y1="4" x2="4" y2="20" stroke="currentColor"/>
                </svg>
                닫기
            </button>
        </div>
    </div>

    <div class="divider-h"></div>
    <form id="mainForm">
        <table class="popup-table">
            <tr>
                <th>사용자ID <span style="color:red">*</span></th>
                <td><input type="text" id="userId" name="userId" class="form-input" required></td>
            </tr>
        </table>
        <div class="divider-h"></div>
        <table class="popup-table">
            <tr>
                <th>사용자이름 <span style="color:red">*</span></th>
                <td><input type="text" id="userNm" name="userNm" class="form-input" required></td>
            </tr> 
            <tr>
                <th>이메일</th>
                <td><input type="text" id="email" name="email" class="form-input"></td>
            </tr>
            <tr>
                <th>전화번호</th>
                <td><input type="text" id="phone" name="phone" class="form-input"></td>
            </tr>
            <tr>
                <th>권한</th>
                <td>
                    <select id="role" name="role" class="form-input">
                        <option value="">선택</option>
                        <option value="0">SUPER</option>
                        <option value="1">ADMIN</option>
                        <option value="2">USER</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>상태</th>
                <td>
                    <select id="stat" name="stat" class="form-input">
                        <option value="0">신청</option>
                        <option value="1">사용</option>
                        <option value="9">미사용</option>
                    </select>
                </td>
            </tr>
        </table>
        <div class="divider-h"></div>
        <table class="popup-table">
            <tr>
                <th>최초등록</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="crtId" name="crtId" class="form-input" readonly>
                    <input type="text" id="crtDttm" name="crtDttm" class="form-input" readonly>   </td>
            </tr>
            <tr>
                <th>최종변경</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="updId" name="updId" class="form-input" readonly>
                    <input type="text" id="updDttm" name="updDttm" class="form-input" readonly> </td>
            </tr>
        </table>
        <div class="divider-h"></div>
    </form>

<br>

    <form id="pwdForm">
        <div class="popup-header">
            <h2 class="popup-title"> ✅ 비밀번호 변경</h2>
            <div class="button-group">
                <button id="btnPwd" type="button" class="btn">
                    <svg viewBox="0 0 24 24" width="15" height="15">
                        <path d="M5 3h14v18H5z" fill="none" stroke="currentColor"/>
                        <path d="M9 3v6h6V3" stroke="currentColor"/>
                    </svg> 저장</button>
            </div>
        </div>
        <div class="divider-h"></div>
        <table class="popup-table">
            <tr>
                <th>현재 비밀번호</th>
                <td><input type="password" id="currentPassword" name="currentPassword" class="form-input" required></td>
            </tr>
            <tr>
                <th>새 비밀번호</th>
                <td><input type="password" id="newPassword" name="newPassword" class="form-input" required></td>
            </tr>
            <tr>
                <th>새 비밀번호 확인</th>
                <td><input type="password" id="confirmPassword" name="confirmPassword" class="form-input" required></td>
            </tr>
        </table>
        <div class="divider-h"></div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const mainForm = document.getElementById("mainForm");
        const btnSave = document.getElementById("btnSave");
        const btnPwd = document.getElementById("btnPwd");

        btnSave.disabled = true;
        btnPwd.disabled = true;

        let originalData = {};

        // 🔸 현재 값이 수정되었는지 체크 (비교 로직 강화)
        const checkChanged = () => {
            const current = formToJson(mainForm);
            // 모든 키를 비교하여 하나라도 다르면 true
            const isDirty = Object.keys(current).some(key => {
                // null/undefined 값을 빈 문자열과 동일하게 취급하여 오탐 방지
                const orgVal = originalData[key] == null ? "" : String(originalData[key]);
                const curVal = current[key] == null ? "" : String(current[key]);
                return orgVal !== curVal;
            });
            btnSave.disabled = !isDirty;
        };

        // 🔸 입력값 변경 감지
        mainForm.querySelectorAll("input, textarea, select").forEach(el => {
            el.addEventListener("input", checkChanged);
            el.addEventListener("change", checkChanged);
        });

        document.getElementById("currentPassword").addEventListener("input", () => {
            btnPwd.disabled = false;
        });

        // 저장 버튼
        btnSave.addEventListener("click", async () => {
            let data = formToJson(mainForm);

            if (!data.phone.trim()) {
                alert("전화번호를 입력하세요.");
                mainForm.phone.focus();
                return;
            }
            if (!data.userNm.trim()) {
                alert("사용자명을 입력하세요.");
                mainForm.userNm.focus();
                return;
            }

            // 공통 필드 추가 (수정자, 수정일시 등)
            data = typeof addUserAuditFields === 'function' ? addUserAuditFields(data) : data;

            try {
                const res = await fetch("/meta/updateUserData", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert("성공적으로 변경되었습니다.");
                    if (window.opener && typeof window.opener.refreshParentRow === 'function') {
                        window.opener.refreshParentRow(data);
                    }
                    window.close();
                } else {
                    alert("변경 실패: " + result.message);
                }
            } catch (err) {
                alert("서버 통신 중 오류가 발생했습니다.");
            }
        });

        // 비밀번호 변경 버튼
        btnPwd.addEventListener("click", (e) => {
            e.preventDefault();

             const userId = document.getElementById('userId').value;
             const currentPass = document.getElementById('currentPassword').value;
             const newPass = document.getElementById('newPassword').value;
             const confirmPass = document.getElementById('confirmPassword').value;

             // 1. 필수 입력 항목 체크
             if (!currentPass || !newPass || !confirmPass) {
                 alert("모든 비밀번호 항목을 입력해야 합니다.");
                 return;
             }

             // 2. 새 비밀번호 일치 확인
             if (newPass !== confirmPass) {
                 alert("새 비밀번호 확인이 일치하지 않습니다.");
                 return;
             }

             // 3. (추가 권장) 현재 비밀번호와 새 비밀번호 동일 여부 체크
             if (currentPass === newPass) {
                 alert("새 비밀번호는 현재 비밀번호와 다르게 설정해야 합니다.");
                 return;
             }

             // 모든 검증 통과 시 API 호출
             changePasswordApi(userId, currentPass, newPass);
         });

         const changePasswordApi = async (userId, currentPassword, newPassword) => {
             btnSave.disabled = true; // 중복 클릭 방지
             try {
                 const res = await fetch("/meta/changePassword", {
                     method: "POST",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ userId, currentPassword, newPassword })
                 });

                 const result = await res.json();

                 if (result.success) {
                     alert("비밀번호가 성공적으로 변경되었습니다.");
                     window.close();
                 } else {
                     alert(`비밀번호 변경 실패: ${result.message || '알 수 없는 오류'}`);
                 }
             } catch (err) {
                 console.error(err);
                 alert("서버와 통신 중 문제가 발생했습니다.");
             } finally {
                 btnPwd.disabled = false;
             }
         };



        // 부모창(리스트)에서 데이터 수신
        window.addEventListener("message", (event) => {
            if (event.origin !== window.location.origin) return;
            const { userId, mode } = event.data;

            if (userId) {
                (async () => {
                    try {
                        const res = await fetch('/meta/getUserData', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId })
                        });

                        const data = await res.json();

                        // 1. 폼 채우기
                        fillForm(mainForm, data);

                        // 2. 수정 모드 처리
                        document.getElementById("userId").readOnly = true;
                        document.getElementById("userId").classList.add("readonly-style"); // 시각적 처리

                        // 3. 변경 감지 기준점 설정 (폼에 채워진 값 기준으로 다시 추출)
                        originalData = formToJson(mainForm);

                        btnSave.disabled = true; // 초기 상태는 비활성

                    } catch (err) {
                        console.error("Fetch Error:", err);
                        alert("데이터 로드 중 오류가 발생했습니다.");
                    }
                })();
            }
        });

        document.getElementById("btnClose").addEventListener("click", () => window.close());

    });
</script>
</body>
</html>