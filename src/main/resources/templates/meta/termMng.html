<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/mainLayout.css">
    <script src="/js/mainLayout.js" defer></script>
    <script src="/js/commonUtils.js" defer></script>
</head>
<body>

<div class="popupContainer" id="popupContainer">
    <div class="popup-header">
        <h2 class="popup-title"> âœ… í‘œì¤€ìš©ì–´</h2>
        <div class="button-group">
            <button id="btnReg" type="button" class="btn">ë“±ë¡
            </button>
            <button id="btnChange" type="button" class="btn">ë³€ê²½
            </button>
            <button id="btnDelete" type="button" class="btn">ì‚­ì œ
            </button>
            <button id="btnInit" type="button" class="btn">ì´ˆê¸°í™”
            </button>
            <button id="btnClose" type="button" class="btn">ë‹«ê¸°
            </button>
        </div>
    </div>
    
    <form id="mainForm">
        <table class="popup-table">
            <tr>
                <th>ìš©ì–´ëª… <span style="color:red">*</span></th>
                <td style="display:flex; align-items:center; gap:4px;">
                    <input type="text" id="trmNm" name="trmNm" class="form-input" required>
                    <button id="btnCheck" type="button" class="btn">ì¤‘ë³µê²€ì¦</button></td>
            </tr>
        </table>
        <table class="popup-table">
            <tr>
                <th>ì˜ë¬¸ëª… <span style="color:red">*</span></th>
                <td > <input type="text" id="engNm" name="engNm" class="form-input" > </td>
            </tr>
            <tr>
                <th>ë„ë©”ì¸ëª…</th>
                <td style="display:flex; align-items:center; gap:4px;">
                    <input type="text" id="dmnNm" name="dmnNm" class="form-input">
<!--                    <button id="btnPopup" type="button">ğŸ”</button>-->
                </td>
            </tr>
            <tr>
                <th>ì„¤ëª…</th>
                <td > <textarea id="trmExpln" name="trmExpln" class="form-input" rows="20" ></textarea> </td>
            </tr>
            <tr>
                <th>ìƒíƒœ</th>
                <td>
                    <select id="stat" name="stat" class="form-input">
                        <option value="" >ì„ íƒ</option>
                        <option value="0" selected>ì‹ ì²­</option>
                        <option value="1">ì‚¬ìš©</option>
                        <option value="9">ë¯¸ì‚¬ìš©</option>
                    </select>
                </td>
            </tr>
        </table>
        <table class="popup-table">
            <tr>
                <th>ìµœì´ˆë“±ë¡</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="crtId" name="crtId" class="form-input" readonly>
                    <input type="text" id="crtDttm" name="crtDttm" class="form-input" readonly>   </td>
            </tr>
            <tr>
                <th>ìµœì¢…ë³€ê²½</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="updId" name="updId" class="form-input" readonly>
                    <input type="text" id="updDttm" name="updDttm" class="form-input" readonly> </td>
            </tr>
        </table>
        <div class="msgInfo"> <span id="msgInfo"></span>   </div>
        </form>
    </div>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const role = localStorage.getItem('role');

        if (!document.forms.mainForm) return;

        const dmnNm = document.forms.mainForm.dmnNm;


        const mainForm = document.getElementById("mainForm");
        const btnReg = document.getElementById("btnReg");
        const btnChange = document.getElementById("btnChange");
        const btnDelete = document.getElementById("btnDelete");
        const btnInit = document.getElementById("btnInit");
        const btnClose = document.getElementById("btnClose");
        const btnCheck = document.getElementById("btnCheck");
        const btnPopup = document.getElementById("btnPopup");

        btnReg.disabled = true;
        btnChange.disabled = true;
        btnDelete.disabled = true;
        btnCheck.disabled = true;

        let mode = "";
        let originalData = {};

        // ë¶€ëª¨ì°½ì—ì„œ ë°ì´í„° ë°›ê¸°
        window.addEventListener("message", (event) => {
            if (event.origin !== window.location.origin) return;
            mode = event.data.mode;
            const trmNmIn  = event.data.trmNm;

            if (mode === "S" && trmNmIn ) {
                btnInit.disabled = true;
                (async () => {
                    try {
                        const res = await fetch('/meta/getTermData', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ trmNm: trmNmIn  })
                        });    const data = await res.json();    fillForm(mainForm, data);
                        document.getElementById("trmNm").readOnly = true;
                        btnInit.disabled = true;
                        originalData = data;    if (btnDelete) {
                            btnDelete.disabled = (role !== '0');
                        }} catch (err) {
                        msgEvents("ìƒì„¸ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                })();

                btnChange.disabled = true;
            }
        });

        // í˜„ì¬ ê°’ì´ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ ì²´í¬
        const checkChanged = () => {
            const current = formToJson(mainForm);
            const changed = Object.keys(current).some(
                key => current[key] !== originalData[key]
            );
            if (mode === "S" ) {
                btnChange.disabled = !changed;
                btnDelete.disabled = true;
            }
        };

        // ì…ë ¥ê°’ ë³€ê²½ ê°ì§€ (ì…ë ¥/ì„ íƒ ëª¨ë‘ ë°˜ì‘)
        mainForm.querySelectorAll("input, textarea, select").forEach(el => {
            el.addEventListener("input", checkChanged);
            el.addEventListener("change", checkChanged);
        });

        document.getElementById("trmNm").addEventListener("input", () => {
            btnReg.disabled = true;
            btnChange.disabled = true;
            btnCheck.disabled = false;
        });

        // ë³€ê²½ ë²„íŠ¼
        btnChange.addEventListener("click", async () => {
            let data = formToJson(mainForm);
            data = addUserAuditFields(data);
            data.func = "U";

             const ok = validateRequired([
                { value: data.engNm.trim(),  message: 'ì˜ë¬¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.engNm },
                { value: data.trmExpln,  message: 'ì„¤ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.trmExpln },
<!--                { value: data.dmnNm,  message: 'ë„ë©”ì¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.dmnNm },-->
                { value: data.stat.trim(),  message: 'ìƒíƒœì½”ë“œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.stat }
            ]);

            if (!ok) return;

            try {
                const res = await fetch("/meta/manageTermData", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    msgEvents("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    if (window.opener && typeof window.opener.refreshParentRow === 'function') {
                        window.opener.refreshParentRow(data);
                    }
                    window.close();
                } else {
                    msgEvents("ì˜¤ë¥˜: " + result.message);
                }

            } catch (err) {
                console.error(err);
                msgEvents("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // ì‚­ì œ ë²„íŠ¼
        btnDelete.addEventListener("click", async () => {

            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            let data = formToJson(mainForm);
            data.func = "D";
            try {
                const res = await fetch("/meta/manageTermData", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    msgEvents("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    if (window.opener && typeof window.opener.refreshParentRow === 'function') {
                        window.opener.refreshParentRow(data);
                    }
                    window.close();
                } else {
                    msgEvents("ì˜¤ë¥˜: " + result.message);
                }

            } catch (err) {
                console.error(err);
                msgEvents("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // ì¤‘ë³µê²€ì¦
       btnCheck.addEventListener('click', async () => {
            let inData = formToJson(mainForm);

            if (!inData.trmNm.trim()) {
                msgEvents("ìš©ì–´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
                mainForm.trmNm.focus();
                return;
            }

            const res = await fetch('/meta/getTermSplitData', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inData)
            });

            btnCheck.disabled = true;
            btnChange.disabled = true;

            const textData = await res.text();
            if (!textData) {
                mainForm.reset();
                mainForm.trmNm.value = inData.trmNm;
                mainForm.engNm.focus();
                btnReg.disabled = false;
                msgEvents( "ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤");
            } else {
                const outData = JSON.parse(textData);
                fillForm(mainForm, outData);
                if (mainForm.stat.value === '0') {
                    msgEvents( "ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤");
                    mainForm.engNm.focus();
                btnReg.disabled = false;
                } else {
                    msgEvents("ë“±ë¡ëœ ìš©ì–´ê°€ ìˆìŠµë‹ˆë‹¤.." );
                    btnReg.disabled = true;
                }
            }
        });

        // ì €ì¥ ë²„íŠ¼
        btnReg.addEventListener("click", async () => {
            let data = formToJson(mainForm);
            data = addUserAuditFields(data);
            data.func = "I";

            const ok = validateRequired([
                { value: data.trmNm.trim(), message: 'ìš©ì–´ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.trmNm },
                { value: data.engNm.trim(),  message: 'ì˜ë¬¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.engNm },
                { value: data.trmExpln,  message: 'ì„¤ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.trmExpln },
<!--                { value: data.dmnNm,  message: 'ë„ë©”ì¸ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.dmnNm },-->
                { value: data.stat.trim(),  message: 'ìƒíƒœì½”ë“œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', element: mainForm.stat }
            ]);

            if (!ok) return;

            if (window.KOR.test(data.engNm)) {
                alert("ì˜ë¬¸ëª…ì—ëŠ” í•œê¸€ì„ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                mainForm.engNm.focus();
                return;
            }

            try {
                let url = "/meta/manageTermData";
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    msgEvents("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.close();
                } else {
                    msgEvents("ì˜¤ë¥˜: " + result.message);
                }

            } catch (err) {
                msgEvents("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });


        // ì´ˆê¸°í™”
        btnInit.addEventListener('click', () => {
            mainForm.reset();
            btnReg.disabled = true;
            btnChange.disabled = true;
            btnCheck.disabled = true;
            msgEvents("");
            document.getElementById("trmNm").focus();
        });

        // Enter Key
        document.getElementById("trmNm").addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                btnCheck.click();
            }
        });

        // ë‹«ê¸°
        btnClose.addEventListener("click", () => window.close() );

        btnPopup.addEventListener("click", async (e) => {
            e.preventDefault();
            const sendData = {dmnNm: document.getElementById("dmnNm").value};
            openWindowWithJSON(sendData, "/meta/dmnSearch", 800, 800);
        });

    });

</script>
</body>
</html>