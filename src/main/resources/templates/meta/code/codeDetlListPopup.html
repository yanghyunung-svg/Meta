<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/mainLayout.css">
    <script src="/js/mainLayout.js" defer></script>
    <script src="/js/commonUtils.js" defer></script>

</head>
<body>
    <div class="popupContainer" id="popupContainer">
        <div class="popupHeadContainer">
            <!-- 왼쪽 타이틀 -->
            <h2 style="margin:0;"> ✅ 상세코드 조회</h2>

            <!-- 오른쪽 버튼 그룹 -->
            <div class="button-group">
                <button id="btnSearch" type="button" class="hidden">조회</button>
                <button id="btnClose" type="button" class="btn">닫기</button>
            </div>
        </div>

        <div class="popupBodyContainer">
        <form id="mainForm">
            <table class="search-table">
                <tr>
                    <th>공통코드</th>
                    <td><input type="text" id="grpCd" name="grpCd" class="search-input" readonly></td>
                    <th>공통코드명</th>
                    <td><input type="text" id="grpNm" name="grpNm" class="search-input" readonly></td>
                </tr>
            </table>
        </form>


        <div id="pageInfoContainer" class="page-header"></div>

        <table class="data-table" id="mainTable">
            <thead>
            <tr>
                <th width="50px" style="text-align: center;">No</th>
                <th>상세코드</th>
                <th>상세코드명</th>
                <th  width="100px" style="text-align: center;">상태</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

    </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {

                // 부모창에서 데이터 받기
                window.addEventListener("message", (event) => {

                    console.log("data",  event.data);

                    if (event.origin  !== window.location.origin) return;

                    const { grpCd, grpNm } = event.data || {};
                    if (!grpCd || !grpNm) return;


                    document.getElementById('grpCd').value = grpCd;
                    document.getElementById('grpNm').value = grpNm;

                    setTimeout(() => {
                        btnSearch.click();
                    }, 30);
                });

                let PAGE_SIZE = 100;
                let dataAll = [];
                let currentPage = 1;

                window.tableBody = document.getElementById("mainTable").querySelector("tbody");
                const btnClose = document.getElementById("btnClose");

                const container = document.getElementById("pageInfoContainer");
                if (!container) return;


                fetch('/common/pageSize.html')
                .then(res => res.text())
                .then(html => {
                    container.innerHTML = html;
                    const pageSelect = document.querySelector('.pageSelect');
                    if (pageSelect) {
                        pageSelect.classList.add('hidden');
                    }
                });


                window.renderTable = function(page)  {
                    if (!Array.isArray(dataAll) || dataAll.length === 0) {
                        return;
                    }

                    const start = (page - 1) * PAGE_SIZE;
                    const end = start + PAGE_SIZE;
                    const pageData = dataAll.slice(start, end);

                    tableBody.innerHTML = pageData.map((item, index) => `
                        <tr>
                            <td style="text-align:center;"> ${start + index + 1} </td>
                            <td style="text-align:left;">${item.cd}</td>
                            <td style="text-align:left;">${item.cdNm}</td>
                            <td style="text-align:center;">${getSttsCdLabel(item.sttsCd)}</td>
                        </tr>
                    `).join('');
                }


                document.getElementById('btnSearch').addEventListener('click', () => {
                    const data = formToJson(document.getElementById('mainForm'));
                    fetch('/meta/getCodeDetlListData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })
                    .then(res => res.json())
                    .then(data => {
                        dataAll = Array.isArray(data) ? data : [];
                        if (!Array.isArray(dataAll) || dataAll.length === 0) {
                            initScreen();
                            document.getElementById("pageInfo").innerText = `조회 결과가 없습니다.`;
                        } else {
                            currentPage = 1;
                            renderTable(currentPage);
                            renderPagination(dataAll, currentPage, PAGE_SIZE);
                            updatePageInfo(dataAll, currentPage, PAGE_SIZE);
                        }
                    })
                    .catch(err => {
                        myAlert("에러 발생: " + err);
                    });
                });
                document.getElementById("btnClose").addEventListener("click", () => {
                    window.close();
                });

                // Escape Key
                document.addEventListener("keydown", e => {
                    if (e.key === "Escape") {
                        e.preventDefault();
                        window.close();
                    }
                });
            });


        </script>
</body>
</html>