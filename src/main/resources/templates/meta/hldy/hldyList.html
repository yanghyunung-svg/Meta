<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/mainLayout.css">
    <script src="/js/mainLayout.js" defer></script>
    <script src="/js/sideLayout.js" defer></script>
    <script src="/js/commonUtils.js" defer></script>


</head>
<body>
<div class="container">
    <div id="topbarContainer"></div>
    <div id="sidebarContainer"></div>
    <div class="mainHeadContainer">
            <!-- 왼쪽 타이틀 -->
            <h2 style="margin:0;"> ✅ 휴일정보 조회</h2>

            <!-- 오른쪽 버튼 그룹 -->
            <div class="button-group">
                <button id="btnSearch" type="button" class="btn">조회                </button>
                <button id="btnReg" type="button" class="btn">등록                </button>
                <button id="btnRegEblc" type="button" class="btn">일괄등록                </button>
            </div>
        </div>

        <div class="mainBodyContainer">
        <form id="mainForm">
            <table class="search-table">
                <tr>
                    <th>조회년도</th>
                    <td style="display:flex; align-items:center; gap:4px;"  width="100px" >
                        <input type="number"
                               id="inqYear"
                               name="inqYear"
                               class="form-input"
                               min="1900"
                               max="2099"
                               step="1"><span>년</span>
                    </td>


                    <th>조회월</th>
                    <td  width="100px">
                        <select id="inqMonth" name="inqMonth" class="form-select">
                            <option value="01">01월</option>
                            <option value="02">02월</option>
                            <option value="03">03월</option>
                            <option value="04">04월</option>
                            <option value="05">05월</option>
                            <option value="06">06월</option>
                            <option value="07">07월</option>
                            <option value="08">08월</option>
                            <option value="09">09월</option>
                            <option value="10">10월</option>
                            <option value="11">11월</option>
                            <option value="12">12월</option>
                        </select>
                    </td>
                    <td width="60%"> </td>
                </tr>
            </table>
        </form>

        <div id="calendarContainer" class="calendar-container"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        let dataAll = [];
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // 01~12
        document.getElementById('inqYear').value = `${year}`;
        document.getElementById('inqMonth').value = `${month}`;

        doSearch();

        document.getElementById('btnSearch').addEventListener('click', doSearch);
        document.getElementById('inqYear').addEventListener('change', doSearch);
        document.getElementById('inqMonth').addEventListener('change', () => { doSearch(); });

        function renderCalendar(year, month, listData) {
            const container = document.getElementById("calendarContainer");
            if (!container) return;

            const firstDay = new Date(year, month - 1, 1);
            const lastDay  = new Date(year, month, 0);
            const startDow = firstDay.getDay(); // 0~6
            const totalDay = lastDay.getDate();

            const hldyMap = {};
            listData.forEach(item => {
                hldyMap[item.crtrYmd] = item;
            });

            let html = `
                <table class="calendar">
                    <thead>
                        <tr>
                            <th>일</th><th>월</th><th>화</th>
                            <th>수</th><th>목</th><th>금</th><th>토</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let day = 1;
            for (let r = 0; r < 6; r++) {
                html += "<tr>";
                for (let c = 0; c < 7; c++) {
                    if ((r === 0 && c < startDow) || day > totalDay) {
                        html += "<td></td>";
                    } else {
                        const ymd = `${year}${String(month).padStart(2, '0')}${String(day).padStart(2, '0')}`;
                        const info = hldyMap[ymd];
                        const cls = info?.hldySeCd === "01" ? "holiday" : "business";

                        html += `
                           <td class="${cls} has-link" data-ymd="${ymd}">
                                <div class="day">${day}</div>
                                ${info ? `<div class="hldyNm">${info.hldyNm}</div>` : ""}
                                ${info?.rmk ? `<div class="rmk">${truncateText(info.rmk, 30)}</div>` : ""}
                            </td>
                        `;
                        day++;
                    }
                }
                html += "</tr>";
                if (day > totalDay) break;
            }

            html += "</tbody></table>";
            container.innerHTML = html;

            container.querySelectorAll("td.has-link").forEach(td => {
                td.addEventListener("dblclick", () => {
                    const ymd = td.dataset.ymd;
                    if (!ymd) return;
                    const sendData = { mode: "S", crtrYmd: ymd };
                    openWindowWithJSON(sendData, "/meta/hldy/hldyMng", 800, 580);
                });
            });
        }

        function doSearch() {
            const data = formToJson(document.getElementById('mainForm'));
            const inqYear  = document.getElementById('inqYear');
            const inqMonth = document.getElementById('inqMonth');

            if (!inqYear.value || !inqYear.value.trim()) {
                inqYear.focus();
                return;
            }

            data.crtrYmd = inqYear.value + (inqMonth.value || '');

            fetch('/meta/getHldyListData', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                dataAll = Array.isArray(data) ? data : [];

                if (dataAll.length === 0) {
                    document.getElementById("calendarContainer").innerHTML = "";
                    return;
                }

                renderCalendar(inqYear.value, inqMonth.value || 1, dataAll);
            })
            .catch(err => myAlert("에러 발생: " + err));
        }
    });

    document.getElementById('btnReg').addEventListener('click', () => {
        const sendData = { mode: "I"};
        openWindowWithJSON(sendData, "/meta/hldy/hldyMng", 800, 580);
    });
    document.getElementById('btnRegEblc').addEventListener('click', () => {
        window.location.href = "/meta/hldy/hldyRegEblc";
    });


</script>
<script src="/js/functionKey.js"></script>
</body>
</html>