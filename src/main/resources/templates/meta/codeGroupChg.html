<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/mainLayout.css">
    <script src="/js/commonUtils.js" defer></script>
</head>
<body>

<div class="popupContainer" id="popupContainer">
    <div class="popup-header">
        <h2 class="popup-title"> ‚úÖ Í∑∏Î£πÏΩîÎìú ÏÉÅÏÑ∏</h2>
        <div class="button-group">
            <button id="btnSave" type="button" class="btn">
                <svg viewBox="0 0 24 24" width="15" height="15">
                    <path d="M5 3h14v18H5z" fill="none" stroke="currentColor"/>
                    <path d="M9 3v6h6V3" stroke="currentColor"/>
                </svg>
                Ï†ÄÏû•
            </button>
            <button id="btnClose" type="button" class="btn">
                <svg viewBox="0 0 24 24" width="15" height="15">
                    <line x1="4" y1="4" x2="20" y2="20" stroke="currentColor"/>
                    <line x1="20" y1="4" x2="4" y2="20" stroke="currentColor"/>
                </svg>
                Îã´Í∏∞
            </button>
        </div>
    </div>

    <div class="divider-h"></div>
    <form id="mainForm">
        <table class="popup-table">
            <tr>
                <th>Í∑∏Î£πÏΩîÎìú <span style="color:red">*</span></th>
                <td colspan="2"> <input type="text" id="grpCd" name="grpCd" class="form-input" required> </td>
            </tr>
            <tr>
                <th>Í∑∏Î£πÏΩîÎìúÎ™Ö <span style="color:red">*</span></th>
                <td colspan="2"> <input type="text" id="grpNm" name="grpNm" class="form-input"  required> </td>
            </tr>
            <tr>
                <th>Ï†ïÎ†¨ÏàúÏÑú</th>
                <td colspan="2"> <input type="text" id="ord" name="ord" class="form-input"  > </td>
            </tr>
            <tr>
                <th>ÎπÑÍ≥†</th>
                <td colspan="2"> <textarea id="rmk" name="rmk" class="form-input" rows="10" ></textarea> </td>
            </tr>
            <tr>
                <th>ÏÉÅÌÉúÏΩîÎìú</th>
                <td colspan="2">
                    <select id="stat"  name="stat" class="form-input">
                        <option value="0">Ïã†Ï≤≠</option>
                        <option value="1">ÏÇ¨Ïö©</option>
                        <option value="9">ÎØ∏ÏÇ¨Ïö©</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>ÏµúÏ¥àÎì±Î°ù</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="crtId" name="crtId" class="form-input"  readonly>
                    <input type="text" id="crtDttm" name="crtDttm" class="form-input"  readonly>   </td>
            </tr>
            <tr>
                <th>ÏµúÏ¢ÖÎ≥ÄÍ≤Ω</th>
                <td style="display:flex; gap:5px;">
                    <input type="text" id="updId" name="updId" class="form-input" readonly>
                    <input type="text" id="updDttm" name="updDttm" class="form-input"  readonly> </td>
            </tr>
        </table>
    </form>
    <div class="divider-h"></div>

</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const mainForm = document.getElementById("mainForm");
        const btnSave = document.getElementById("btnSave");

        // ÌòÑÏû¨ ÌôîÎ©¥ ÏÉÅÌÉú: I(Ïã†Í∑ú), S(ÏÉÅÏÑ∏)
        let mode = "I";
        let originalData = {};

         // üî∏ ÌòÑÏû¨ Í∞íÏù¥ ÏàòÏ†ïÎêòÏóàÎäîÏßÄ Ï≤¥ÌÅ¨
          const checkChanged = () => {
            const current = formToJson(mainForm);
            const changed = Object.keys(current).some(
                key => current[key] !== originalData[key]
            );
            btnSave.disabled = !changed;
        };

        // üî∏ ÏûÖÎ†•Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ (ÏûÖÎ†•/ÏÑ†ÌÉù Î™®Îëê Î∞òÏùë)
        mainForm.querySelectorAll("input, textarea, select").forEach(el => {
            el.addEventListener("input", checkChanged);
            el.addEventListener("change", checkChanged);
        });

        // Ï†ÄÏû• Î≤ÑÌäº
        btnSave.addEventListener("click", async () => {
            let data = formToJson(mainForm);
            data = addUserAuditFields(data);

            if (!data.grpCd.trim()) {
                alert("Í≥µÌÜµÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                mainForm.grpCd.focus();
                return;
            }
            if (!data.grpNm.trim()) {
                alert("Í≥µÌÜµÏΩîÎìúÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                mainForm.grpNm.focus();
                return;
            }

            try {
                let url = "/meta/updateCodeGroupData" ;

                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                    if (window.opener && typeof window.opener.refreshParentRow === 'function') {
                        window.opener.refreshParentRow(data);
                    }
                    window.close();
                } else {
                    alert("Ïò§Î•ò: " + result.message);
                }

            } catch (err) {
                console.error(err);
                alert("ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            }
        });


        // Î∂ÄÎ™®Ï∞ΩÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∞õÍ∏∞
        window.addEventListener("message", (event) => {
            if (event.origin !== window.location.origin) return;

            mode = event.data.mode;
            const sendId  = event.data.grpCd;

            // ÏÉÅÏÑ∏Î™®Îìú
            if (mode === "S" && sendId ) {
                (async () => {
                    try {
                        const res = await fetch('/meta/getCodeGroupData', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ grpCd: sendId  })
                        });

                        const data = await res.json();

                        fillForm(mainForm, data);
                        // ÏùΩÍ∏∞ Ï†ÑÏö©
                        document.getElementById("grpCd").readOnly = true;

                        const userId = localStorage.getItem('userId');
                        document.getElementById("updId").value = userId;

                        originalData = data; // Î≥ÄÍ≤ΩÍ∞êÏßÄ Í∏∞Ï§Ä Îì±Î°ù

                    } catch (err) {
                        console.error(err);
                        alert("ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    }
                })();

                btnSave.disabled = true;

            } else if (mode === "I") {
                originalData = formToJson(mainForm);
                btnSave.disabled = false;
            }
        });

        document.getElementById("btnClose").addEventListener("click", () => {
            window.close();
        });

    });

</script>
</body>
</html>

