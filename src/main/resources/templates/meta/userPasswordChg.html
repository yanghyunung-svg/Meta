<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Meta System</title>
    <link rel="stylesheet" href="/css/layout.css">
    <script src="/js/commonUtils.js"></script>
</head>
<body>

<div class="popupContainer" id="popupContainer">
    <div class="popup-header">
        <h2 class="popup-title"> ✅ 비밀번호 변경</h2>
        <div class="button-group">
            <button id="btnSave" class="btn">저장</button>
            <button id="btnClose" class="btn">닫기</button>
        </div>
    </div>

    <div class="divider-h"></div>
    <form id="mainForm">
        <table class="popup-table">
            <tr>
                <th>사용자ID <span style="color:red">*</span></th>
                <td><input type="text" id="userId" name="userId" class="form-input" readonly></td>
            </tr>
            <tr>
                <th>사용자명 <span style="color:red">*</span></th>
                <td><input type="text" id="userNm" name="userNm" class="form-input" readonly></td>
            </tr>
        </table>
        <div class="divider-h"></div>
        <table class="popup-table">
            <tr>
                <th>현재 비밀번호</th>
                <td><input type="password" id="currentPassword" name="currentPassword" class="form-input" required></td>
            </tr>
            <tr>
                <th>새 비밀번호</th>
                <td><input type="password" id="newPassword" name="newPassword" class="form-input" required></td>
            </tr>
            <tr>
                <th>새 비밀번호 확인</th>
                <td><input type="password" id="confirmPassword" name="confirmPassword" class="form-input" required></td>
            </tr>
        </table>
    </form>
    <div class="divider-h"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
         const mainForm = document.getElementById("mainForm");
         const btnSave = document.getElementById('btnSave');
         const btnClose = document.getElementById('btnClose');

         btnSave.addEventListener('click', () => {

             const userId = document.getElementById('userId').value;
             const currentPass = document.getElementById('currentPassword').value;
             const newPass = document.getElementById('newPassword').value;
             const confirmPass = document.getElementById('confirmPassword').value;

             // 1. 필수 입력 항목 체크
             if (!currentPass || !newPass || !confirmPass) {
                 alert("모든 비밀번호 항목을 입력해야 합니다.");
                 return;
             }

             // 2. 새 비밀번호 일치 확인
             if (newPass !== confirmPass) {
                 alert("새 비밀번호 확인이 일치하지 않습니다.");
                 return;
             }

             // 3. (추가 권장) 현재 비밀번호와 새 비밀번호 동일 여부 체크
             if (currentPass === newPass) {
                 alert("새 비밀번호는 현재 비밀번호와 다르게 설정해야 합니다.");
                 return;
             }

             // 모든 검증 통과 시 API 호출
             changePasswordApi(userId, currentPass, newPass);
         });

         const changePasswordApi = async (userId, currentPassword, newPassword) => {
             btnSave.disabled = true; // 중복 클릭 방지
             try {
                 const res = await fetch("/meta/changePassword", {
                     method: "POST",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ userId, currentPassword, newPassword })
                 });

                 const result = await res.json();

                 if (result.success) {
                     alert("✅ 비밀번호가 성공적으로 변경되었습니다.");
                     window.close(); // 부모창에서 열린 팝업 닫기
                 } else {
                     alert(`비밀번호 변경 실패: ${result.message || '알 수 없는 오류'}`);
                 }
             } catch (err) {
                 console.error(err);
                 alert("서버와 통신 중 문제가 발생했습니다.");
             } finally {
                 btnSave.disabled = false;
             }
         };

         // 부모 창으로부터 데이터 수신
         window.addEventListener("message", (event) => {
             if (event.origin !== window.location.origin) return;

             const { userId, userNm } = event.data;

             if (userId) document.getElementById("userId").value = userId;
             if (userNm) document.getElementById("userNm").value = userNm;

             // 데이터 로드 후 버튼 활성화
             btnSave.disabled = false;
         });

         btnClose.addEventListener("click", () => { window.close(); });

        // Enter Key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btnSave').click();
            }
        });

     });
</script>
</body>
</html>